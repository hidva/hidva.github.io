---
title: "从0到1：微信后台系统的演进之路"
tags: [读后感]
---


1.  消息模型; 存储转发, 消息被发出后, 会先在后台临时存储; 为使接收者能更快接收到消息, 会推送消息通知给接收者; 最后客户端主动到服务器收取消息.

2.  数据同步协议; 参见原文.

    -   Q1: "我们决定通过一个统一的数据同步协议来同步用户所有的基础数据" 这里啥意思? 假设用户基础数据分为几类, 这里的意思是说每类基础数据单独同步但使用相同的协议? 还是说所有数据放在一起进行同步使用相同的协议?
    -   A1: 按照我的理解, 应该是"每类基础数据单独同步但使用相同的协议".

    我本来以为 key 的取值是:  用户账户数据, 联系人数据, 联系人A的消息, 联系人B的消息等, 即把消息按照来源进行了切分. 但是微信的实现是把消息作为一个整体, 这样确实更合适.

    -   Q1: 微信再收到客户端上传来的版本号之后是如何计算差异的呢? 根据原文"例如清除暂存在服务的消息等等。"的意思好像是服务端保存着每个版本对应的数据, 当收到客户端上传的版本号之后计算出相应的差异数据, 然后删除旧版本号对应的数据. 但是这有一个问题如果用户多端登录, 假设端 A 端 B 保存着相同的版本号 v,  然后端 A 先同步, 同步完成之后服务端删除版本号 v 对应的数据, 那么端 B 在同步时该咋办?

3.  尽量由服务器完成较复杂的业务逻辑, 降低客户端实现的复杂. 不知道微信为什么采用这个策略, 但是根据原文中群聊案例可知这个策略很是成功.

4.  后台架构; 微信后台采用微服务架构, 即存在多种服务. 服务基于 Svrkit 框架使用 c++ 开发. 服务之间通过同步 RPC 进行通讯. 根据业务逻辑将服务归纳为: 接入层, 逻辑层和存储层.

    Svrkit 其架构非常类似于 thrift.

5.  群聊实现. 群聊是耗时操作, 消息发到群后, 可以通过异步队列来异步完成消息的扩散写等等. 按照我的理解应该会有一个问题当 a 发送了群消息, 然后 b 拉 c 进群, 所以可能会出现一个场景在 a 看来 c 是在她发送消息之后进来的 c 不应该收到消息, 但是由于消息是异步写的, 所以 c 可能会收到消息. 这个也不是大问题而且我想了一会没想到解决方案.

    -   Q1: 原文与微博进行了比较, 考虑到微博大 v 几千万的粉丝量, 用扩散写大概会爆吧? 那微博怎么做的?


6.  基于 ID-Value 的业务无关的监控告警体系. 这个叙述太少没咋地看懂.

7.  存储模块迭代, 参见原文进行了解, 也挺接地气的嘛.

8.  KVSvr 使用基于 Quorum 的分布式数据强一致性算法, 提供 Key-Value/Key-Table 模型的存储服务. 传统Quorum算法的性能不高, KVSvr创造性地将数据的版本和数据本身做了区分, 将Quorum算法应用到数据的版本的协商, 再通过基于流水同步的异步数据复制提供了数据强一致性保证和极高的数据写入性能. 居然是用 Quorum 这么原始的算法(Quorum 好像没有我想象中的过时啊..). 而且具体 "应用到数据的版本的协商" 也没细说啊. 真是的.

8.  数据中心之间的同步, 参考原文了解相关经验.

    在 "可靠的数据同步"  一节介绍了一个基于 Quorum 算法的队列组件. 但是介绍的不是很清楚按照我的理解如下:

    -   这个队列组件分为若干组, 每一组由3机存储服务组成, 各组之间相互独立.
    -   写时逻辑, 见原文.
    -   读时逻辑, 原文未细讲, 按照我的理解, 其他数据中心的数据重放服务需要遍历队列组件中的所有组, 每一组的最新数据都要读取. 毕竟需要同步的数据可能分散到任何组上, 而且没有规律.

    现在看起来, 这个特别像 kafka 的模型. 而且看上去 kafka 确实是在此后才出现的.


## 参考

1.  [原文][000]


[000]: <https://mp.weixin.qq.com/s?__biz=MzI4NDMyNTU2Mw==&mid=2247483676&idx=1&sn=baff64ea4109be94b5fea36dc1a1f8b6&mpshare=1&scene=1&srcid=06128LdYrS7fr2aKKCvSo3F3&key=f17d8322b1674f1fd3496f75aa3bddde0231d6230c7b156bc66945794be5dce29473804e9b1b7300dbbc04184c6dab2f5710e5b4ce204836aa223b62ecac130fd35dabc211d14a6e40d4e666e678b704&ascene=0&uin=ODAwODc5Mjgw&devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.12.5+build(16F73)&version=12020810&nettype=WIFI&fontScale=100&pass_ticket=S%2FhdM%2Bh07%2BxWXLffgMiAUVAr4I1OzobqnZ8HbK8w9VTf8FemCJyI%2BiQ0UcEjMurO> "从0到1：微信后台系统的演进之路 [2017-06-12]"

