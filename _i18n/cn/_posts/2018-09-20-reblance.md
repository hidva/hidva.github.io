---
title: "以表格存储为例，解密阿里在分布式负载均衡的核心力"
tags: [读后感, 分布式存储]
---

原文介绍了分布式 Table 系统中的负载均衡经验, 但按我直觉来看这里的经验并不仅仅局限与 Table 存储系统. 以在百度做 bigpipe 经验来看, bigpipe 的负载均衡也可以借鉴一下这里的思想. 所以接下来会尽量从更广义的角度来理解这篇文章.

本文负载均衡所依附的分布式存储系统的系统架构以及数据模型. 这里系统架构就是很常见的分布式存储系统架构: master, 负责元信息的存储以及负载均衡; worker 负责执行实际的读写操作. 从我目前了解到的系统来看, 百度的 bigpipe, PingCAP 的 tidb 都是这种结构. 数据模型, 分布式存储系统中常用分而治之的思想将规模拆分成单机可以处理的水平, 然后让单机承载相应的功能. 主流的拆分方式有 hash, range; 按我理解在数据查找方面, hash 拆分方式更省一筹; 可以将 hash, range 拆分方式分别类比为 std::unordered_map, std::map; 即 hash 拆分中数据查找是哈希取余, 时间复杂度 O(1); range 拆分中数据查找需要不断二分, 时间复杂度 O(log2n). 但在扩容时需要迁移的数据量方面, 相对而言, range 需要迁移的数据量应该更少一点. 和 bigpipe, tidb 一样, 原文 Table 也是采用 range 拆分方式.

本文负载均衡涉及到的概念; 机器, emmm 就是普通的机器, 单台服务器这种. 资源, 就是机器提供的各种资源, 比如 CPU, 内存, 带宽, IO 等都是资源; 资源可被量化. 租户, 租户位于指定的机器上, 会消耗机器上的各类资源, 同样租户消耗的资源也可被量化. 忽然发现负载均衡存在于方方面面, 比如在内核进程调度中, CPU 就是资源, 进程就是租户.

负载均衡中请求资源量化和统计, 原文介绍了一个很不错的请求资源量化以及统计模型, 参见原文. 核心是在请求处理时量化记录当前请求所消耗的资源, 然后异步完成资源的统计操作. 负责异步统计资源的线程可以视作纯计算型, 可单独绑定到一个核上执行, 根据原文数据, 异步统计资源 QPS: 70w/s.

负载均衡中的流控, 由[认清性能问题]({{site.url}}/2018/09/20/performance/)中信息可知, 不论有没有负载均衡, 单机流控都必不可少. 如果按照我之前想法, 不进行任何流控放任处理, 那么势必会影响单机上的所有租户. 参见原文的流控架构了解相关细节, 不过这里仍有很多细节未透漏讲明, 比如资源水位线具体体现? 资源的分配与释放究竟是种怎样的操作? 等. 这里推导一下流控结构中的概率公式, 本来我还以为是拍脑袋拍出来的呢. 根据上文所述, 资源统计模块会周期性输出一张视图表明资源使用情况. 流控概率公式认为下一个周期内资源使用情况与当前周期相同. 若当前周期内资源使用未超出机器资源水位线, 也表明下一个周期也不会超出, 此时不会进行任何流控. 反之若资源使用超出机器资源水位线, 则需要流控介入使得后续周期资源使用回归水位线一下. 下面以网络出口带宽资源为例演示公式推导, 这里假设当前周期内出口带宽 9000m/s, 机器出口带宽水位线 8000m/s, 那么则意味着需要拒绝 9000 中的 (9000 - 8000) 部分. 这里先假设当前机器上所有租户上的所有请求消耗相同的出口带宽, 那么此时意味着拒绝 1/9 的请求即可, 但实际情况并非如此. 这里用 $$n$$ 表明当前机器租户个数, $$x_i$$ 表明租户 $$i$$ 消费出口带宽, $$p_i$$ 表明租户请求被拒绝的概率, 那么有

$$\sum_{i=1}^n x_i = 9000$$

$$\sum_{i=1}^n x_i(1 - p_i) = 8000$$

由于需要保护小流量租户, 即谁的流量大被拒绝的概率也大, 所以另 $$p_i = k \cdot x_i$$, 其中 $$k$$ 为常数. 此时可以推出

$$k = { 1000 \over \sum_{i=1}^n {x_i ^ 2} }$$

所以可得:

$$p_i = { 1000 x_i \over \sum_{i=1}^n {x_i ^ 2} }$$

另 $$R$$ 标识资源繁忙的程度, 即 $$R = {9000 - 8000 \over 9000}$$, 可得:

$$p_i = { {x_i \over {\sum_{i=1}^n {x_i ^ 2}}} \cdot \sum_{i=1}^n x_i \cdot R  }$$


负载均衡闭环, 参见原文了解. 按我理解此时负载均衡触发规则有如下几条:

-   由于流控导致某租户请求成功率低于 SLA; 或者由于租户所在机器繁忙, 导致租户请求响应时间低于 SLA
-   存在机器, 资源利用率过低

负载均衡的动作, 参见原文了解, 注意在分区分裂动作中, 若分裂点未落在访问区间边界, 那么可以像[直方图技术](https://github.com/facebook/folly/blob/master/folly/stats/Histogram.h)中一样采用拟合的方式.

负载均衡评估标准, 或者说终态, 参见原文, 注意

> 能够在确定时间内解决用户业务暴涨问题

这个确定时间根据互联网 8 秒原则, 我觉得设置为 8 秒较为合适.


# 参考

-   [以表格存储为例，解密阿里在分布式负载均衡的核心力][20180920211752]

[20180920211752]: <https://mp.weixin.qq.com/s/_EgejvRjsvq0iIpDA2Vl0A> "最后修订: 2018 年 4 月 9 日"
