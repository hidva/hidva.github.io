---
---

# 线程安全与全局优化

## 线程安全
*   一般情况下;glibc 中标注为线程安全的函数就是线程安全的;除非开启了全局优化.

## 全局优化
*   当开启全局优化时,即使函数在源文件中实现也会可能会被内联;
*   开启全局优化后,可能会出现不安全的重排序,导致标注为线程安全的函数不再是线程安全的.

# 异步信号安全
*   信号处理函数,其布局应该总是如下所示:
    
    ```c
    保存线程局部状态;如: errno,浮点执行环境;
    进行业务处理;
    恢复线程局部状态;
    ```

# 异步取消安全
*   即在线程启用异步取消后,仍能被安全调用的函数;一些可能会分配资源的函数很显然不是异步取消的.
*   线程取消处理函数;由于线程取消处理程序调用时机不鸣;所以线程取消程序在执行真正操作之前应该做些初
    始化操作;主要是初始化线程状态;如:浮点执行环境.

# 宏的深度用法
*   对于带有参数的宏来说,仅当其后面带有'('时,才会被展开;如:

    ```c++
    #define abs(x) (x)
    
    // 此时不会展开 abs;因为其后面未跟'('
    int (abs)(int x) 
    {
        return x;
    }
    
    // 此时不会展开 abs;因为其后面未跟'('
    auto *ptr = &abs;    
    ```
    
    